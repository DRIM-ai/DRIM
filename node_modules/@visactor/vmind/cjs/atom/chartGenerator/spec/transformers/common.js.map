{"version":3,"sources":["../src/atom/chartGenerator/spec/transformers/common.ts"],"names":[],"mappings":"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","file":"common.js","sourcesContent":["import type { GenerateChartCellContext } from '../../type';\nimport { getVChartTypeByVmind } from '../chartTypeUtils';\nimport { isValidDataTable } from '../../../../utils/dataTable';\nimport { builtinThemeMap } from '../../const';\nimport {\n  animationDuration,\n  COLOR_THEMES,\n  DEFAULT_VIDEO_LENGTH,\n  DEFAULT_VIDEO_LENGTH_LONG,\n  oneByOneGroupSize\n} from '../constants';\nimport { isArray } from '@visactor/vutils';\nimport { getFieldIdInCell } from '../../../../utils/field';\n\n/**\n * 更新spec中的图表类型\n * @param context\n * @returns\n */\nexport const revisedVChartType = (context: GenerateChartCellContext) => {\n  const { chartType, spec } = context;\n\n  spec.type = getVChartTypeByVmind(chartType);\n\n  return { spec };\n};\n\nexport const data = (context: GenerateChartCellContext) => {\n  const { dataTable, spec } = context;\n  spec.data = {\n    id: 'data',\n    values: isValidDataTable(dataTable) ? dataTable.flat(4) : []\n  };\n\n  return { spec };\n};\n\nexport const arrayData = (context: GenerateChartCellContext) => {\n  const { dataTable, spec } = context;\n  spec.data = [\n    {\n      id: 'data',\n      values: isValidDataTable(dataTable) ? dataTable.flat(4) : []\n    }\n  ];\n  return { spec };\n};\n\nexport const discreteLegend = (context: GenerateChartCellContext) => {\n  const { cell, spec } = context;\n\n  if (spec.legends || (!(cell.color || cell.category) && !spec.seriesField && spec.type !== 'common')) {\n    return { spec };\n  }\n  spec.legends = [\n    {\n      orient: 'right',\n      type: 'discrete',\n      item: {\n        visible: true,\n        background: {\n          style: {\n            //fillOpacity: 0\n          }\n        },\n        label: {\n          style: {\n            //fill: '#FFFFFF'\n          }\n        },\n        shape: {\n          style: {\n            //symbolType: 'rect'\n          }\n        }\n      }\n    }\n  ];\n\n  return { spec };\n};\n\nexport const theme = (context: GenerateChartCellContext) => {\n  const { chartTheme, spec } = context;\n\n  if (typeof chartTheme === 'string') {\n    Object.keys(builtinThemeMap).some(key => {\n      if (key === chartTheme) {\n        spec.theme = builtinThemeMap[chartTheme];\n        return true;\n      }\n      return false;\n    });\n  } else if (typeof chartTheme === 'object') {\n    spec.theme = chartTheme;\n  }\n  if (spec.theme && spec.theme.colorScheme) {\n    spec.color = undefined;\n  }\n\n  return { spec };\n};\n\nexport const color = (context: GenerateChartCellContext) => {\n  const { colors, spec, chartTheme } = context;\n  if (chartTheme) {\n    return { spec };\n  }\n  // spec.data = [dataTable]\n  if (colors && colors.length > 0) {\n    spec.color = colors;\n  } else {\n    spec.color = COLOR_THEMES.default;\n  }\n\n  return { spec };\n};\n\nexport const commonLabel = (context: GenerateChartCellContext) => {\n  const { spec, fieldInfo, cell } = context;\n  const { y: celly } = cell;\n  spec.label = {\n    visible: true\n  };\n  if (isArray(celly) && celly.length > 1) {\n  } else if (celly) {\n    const field = isArray(celly) ? celly[0] : celly;\n    const info = fieldInfo.find(v => v.fieldName === field);\n    if (info?.ratioGranularity) {\n      spec.label.formatter = `{${field}:~%}`;\n    }\n  }\n  return { spec };\n};\n\nexport const indicator = (context: GenerateChartCellContext) => {\n  const { spec, cell } = context;\n  const firstEntry = spec.data.values[0];\n  if (!firstEntry) {\n    return { spec };\n  }\n  const valueField = (cell.value ?? cell.y) as string;\n  const value = firstEntry[valueField];\n  const cat = firstEntry[getFieldIdInCell(cell.radius ?? cell.x)];\n\n  spec.indicator = {\n    visible: true,\n    fixed: true,\n    trigger: 'none',\n    title: {\n      visible: true,\n      autoLimit: true,\n      space: 12,\n      style: {\n        fontSize: 16,\n        fill: 'gray',\n        text: cat ?? valueField\n      }\n    },\n    content: [\n      {\n        visible: true,\n        style: {\n          fontSize: 20,\n          fill: '#000',\n          text: `${(value * 100).toFixed(1)}%`\n        }\n      }\n    ]\n  };\n  return { spec };\n};\n\nexport const sunburstOrTreemapField = (context: GenerateChartCellContext) => {\n  //assign field in spec according to cell\n  const { spec } = context;\n  spec.categoryField = 'name';\n\n  spec.valueField = 'value';\n\n  return { spec };\n};\n\nexport function onlyUnique(value: any, index: number, array: any) {\n  return array.indexOf(value) === index;\n}\n\nexport const oneByOneDelayFunc = (delay: number) => (datum: any) => {\n  const group = datum.__CHARTSPACE_DEFAULT_DATA_INDEX % oneByOneGroupSize;\n  return group * delay;\n};\n\nexport const animationOneByOne = (context: GenerateChartCellContext) => {\n  const { spec } = context;\n\n  if (spec.type === 'wordCloud3d') {\n    return { spec };\n  }\n  const totalTime = context.totalTime ?? DEFAULT_VIDEO_LENGTH_LONG;\n  const duration = animationDuration;\n  const dataLength = spec.data.values.length;\n  const delay = Math.max(totalTime / dataLength - duration, 0);\n  const finalDuration = delay === 0 ? totalTime / dataLength : duration;\n  const finalDelay = delay === 0 ? Number.MIN_VALUE : delay;\n\n  spec.animationAppear = {\n    //word: [\n    //  {\n    //    channel: {\n    //      fontSize: {\n    //        from: 0,\n    //      },\n    //    },\n    //    duration: animationDuration,\n    //    delay: oneByOneDelayFunc(delay),\n    //  },\n    //],\n    oneByOne: finalDelay,\n    duration: finalDuration\n  };\n  return { spec };\n};\n\nexport const animationCartisianLine = (context: GenerateChartCellContext) => {\n  const { spec } = context;\n\n  const totalTime = context.totalTime ?? DEFAULT_VIDEO_LENGTH;\n  const groupKey = Array.isArray(spec.xField) ? spec.xField[0] : spec.xField;\n  const dataValues = spec.data.values as any[];\n  const groups = dataValues.map(d => d[groupKey]).filter(onlyUnique);\n  const groupNum = groups.length;\n  const lineAnimationTotalTime = totalTime > 2000 ? 2000 : totalTime;\n  const pointDelay = lineAnimationTotalTime / groupNum;\n  spec.animationAppear = {\n    line: {\n      type: 'clipIn',\n      duration: lineAnimationTotalTime,\n      easing: 'linear'\n    },\n    point: {\n      delay: (datum: any) => {\n        const groupIndex = groups.findIndex(d => d === datum[groupKey]);\n        return groupIndex * pointDelay;\n      }\n    }\n  };\n\n  spec.animationNormal = {\n    point: {\n      loop: true,\n      timeSlices: [\n        {\n          effects: {\n            channel: {\n              size: { to: 14 }\n            },\n            easing: 'circInOut'\n          },\n          duration: 1000\n        },\n        {\n          effects: {\n            channel: {\n              size: { to: 10 }\n            },\n            easing: 'circInOut'\n          },\n          duration: 500\n        }\n      ]\n    }\n  };\n  return { spec };\n};\n"]}