import NodeSQLParser from 'node-sql-parser';
import { query } from '../query';
import { parseRespondField, preprocessSQL } from './utils';
import { parseSqlAST } from './parseSqlAST';
import { isArray } from '@visactor/vutils';
export const queryDataset = async (sql, fieldInfo, sourceDataset) => {
    const { validStr, replaceMap } = preprocessSQL(sql, fieldInfo);
    const parser = new NodeSQLParser.Parser();
    const ast = parser.astify(validStr);
    const queryObject = parseSqlAST((isArray(ast) ? ast[0] : ast), sourceDataset, fieldInfo, replaceMap);
    const dataset = query(queryObject);
    const fieldInfoNew = parseRespondField(fieldInfo, dataset, replaceMap);
    return {
        dataset: dataset.length === 0 ? sourceDataset : dataset,
        fieldInfo: dataset.length === 0 ? fieldInfo : fieldInfoNew
    };
};
